- name: Remove environments
  hosts: localhost
  connection: local
  become: no
  gather_facts: no
  vars:
    stud_num: []
    stud_num2: [""]
  tasks:

    - name: generate users list
      set_fact:
        users: "{{ users|default([]) + [ {'name': 'student' + item, 'username': 'student' + item, 'email': 'student' + item + '@example.com'} ] }}"
      with_sequence: start="{{ student_count_start }}" end="{{ student_count_end }}"

    - name: Debug users
      debug: var=users

    - name: Login to OnTap Instance
      uri:
        url:  http://204.236.211.203:80/occm/api/auth/login
        method: POST
        body_format: json
        body: { "email": "lrich00@gmail.com", "password": "password00!" }
        status_code: 204
      register: login

    - name: Get working environments
      uri:
        url: http://204.236.211.203:80/occm/api/vsa/working-environments
        method: Get
        validate_certs: no
        return_content: yes
        status_code: 200
        headers:
          Cookie: "{{ login.set_cookie }}"
      register: working_environments

    - debug: var=working_environments

    - name: parse variable
      debug:
        var: item
      loop: "{{ working_environments | json_query('json[*].svmName') }}"

    - name: Show publicID
      debug:
        var: item
      loop: "{{ working_environments | json_query(id_query) }}"
      vars:
        #id_query: "json[?svmName=='svm_citi_student*'].publicId"
        id_query: "json[?contains(svmName, `svm_citi_student`].publicId"
      register: pubid

    - name: Set fact
      set_fact:
        stud_num: "json[?svmName=='svm_citi_student{{item}}'].publicId"
        stud_num2: "{{ stud_num }} + {{ stud_num2 }}"
      with_sequence: start=1 end=16

    - name: debug set fact
      debug: var=stud_num2
      #with_items: "{{ stud_num[14] }}"

  #  - name: Show publicID loop
  #    debug:
  #      msg: "Running my loop"
  #    #with_nested:
  #      #- "{{ stud_num2 }}"
  #    loop: "{{ working_environments | json_query(stud_num2) }}"
  #    #with_items: "{{ stud_num2 }}"
  #  #  vars:
  #  #    id_query: "json[?svmName=='svm_citi_{{item.0.name}}'].publicId"
  #    register: pubid2

    - name: Display PubID
      debug: var=pubid.results[0].item

    - name: Remove working environment
      uri:
        url: http://204.236.211.203:80/occm/api/vsa/working-environments/
        method: Get
        validate_certs: no
        return_content: yes
        status_code: 200
        headers:
          Cookie: "{{ login.set_cookie }}"
